# Tutorial Docker Swarm

## Create the manager and workers
* ```docker-machine create --driver virtualbox manager```
* ```docker-machine create --driver virtualbox worker1```
* ```docker-machine create --driver virtualbox worker2```

## Create the Docker image at manager and workers
* Run at project path: ```eval $(docker-machine env worker1) ; docker build --build-arg VERSION=1.0-SNAPSHOT --build-arg SIMULATION=gatling.simulations.BasicSimulation -t gatling:latest . ; eval $(docker-machine env -u)```
* Run at project path: ```eval $(docker-machine env worker2) ; docker build --build-arg VERSION=1.0-SNAPSHOT --build-arg SIMULATION=gatling.simulations.BasicSimulation -t gatling:latest . ; eval $(docker-machine env -u)```
* Run at project path: ```eval $(docker-machine env manager) ; docker build --build-arg VERSION=1.0-SNAPSHOT --build-arg SIMULATION=gatling.simulations.BasicSimulation -t gatling:latest . ; eval $(docker-machine env -u)```

## Create the Swarm
* SSH Manager: ```docker-machine ssh manager```
* Run: ```docker swarm init --advertise-addr <IP_ADDR_OF_MANAGER>```
* Copy the line generated by the command above, if you lose the command line please run the command: ``` docker swarm join-token worker at manager ```
* [Help Docker](https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/)

## Join the workers to Swarm (Manager)
* SSH Worker1/2: ```docker-machine ssh worker[1|2]```
* Run the line generated from swarm join-token, should be a command like: ```docker swarm join --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c 192.168.99.104:2377```
* [Help Docker](https://docs.docker.com/engine/swarm/swarm-tutorial/add-nodes/)

## Deploy the service and run
* Run at project path: ```docker stack deploy --compose-file gatling-stack.yaml gatling```

### Help commands
* Java execution: ```java -cp target/gatling-docker-swarm-1.0-SNAPSHOT.jar io.gatling.app.Gatling -s gatling.simulations.BasicSimulation```
* Docker build image: ```docker build --build-arg VERSION=1.0-SNAPSHOT --build-arg SIMULATION=gatling.simulations.BasicSimulation -t gatling:latest .```
* Clean all containers: ```docker container prune```
* Clean the service: ```docker service rm gatling_gatling```
* Show logs from machine: ```docker-machine ssh worker1; docker container logs `docker container ls -all | awk 'END{print $1}'```
